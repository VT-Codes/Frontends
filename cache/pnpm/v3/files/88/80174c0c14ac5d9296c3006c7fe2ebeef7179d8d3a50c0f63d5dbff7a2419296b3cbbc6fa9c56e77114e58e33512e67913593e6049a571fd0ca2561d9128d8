const a5_0x3523=['toString','push','map','Distributed\x20Execution\x20Terminated','End\x20all\x20currently\x20running\x20agents,\x20run\x20\x22npx\x20nx-cloud\x20clean-up-agents\x22,\x20and\x20try\x20again.','Command\x20execution\x20failed\x20(distributed\x20task\x20execution:\x20',').\x20Tasks\x20hashes\x20haven\x27t\x20been\x20recorded.','reset','createNoNewMessagesTimeout','child_process','projects','status','CIRCLE_STAGE','throw','This\x20can\x20also\x20be\x20a\x20false\x20positive\x20caused\x20by\x20agents\x20that\x20did\x20not\x20shut\x20down\x20correctly.','\x20--projects=','forEach','/tasks-hashes-','../../../utilities/waiter','tasks','--configuration=','unlinkSync','Waiting...','NX_AGENT_NAME','VERBOSE_LOGGING','tasksRunnerOptions','cacheDirectory','Critical\x20Error\x20in\x20Agent:\x20\x22','npx\x20nx\x20run-many\x20--target=','startAgent','retryDuring:\x20','Other\x20Nx\x20Cloud\x20Agents\x20Detected','executionId','submitRunMetrics','value','defineProperty','warn','completedStatusCode','readFileSync','getTime','assign','SIGINT','readdirSync','./node_modules/.cache/nx','Starting\x20an\x20agent\x20for\x20running\x20Nx\x20tasks','executionId:\x20','target','completed','message','Executing:\x20\x27','../../../utilities/metric-logger','env','configuration','random','existsSync','../../error/print-run-group-error','length','parse','../../../utilities/environment','CIRCLECI','join','exit','__esModule','writeFileSync','retryDuring','completed:\x20','next','./distributed-agent.api','.lock','criticalErrorMessage','Waiter','strip-json-comments','maxParallel:\x20','floor','apply','projectName','note','../../../utilities/nx-imports','completedTasks','true','done','inherit','number\x20of\x20tasks:\x20','wait','maxParallel','params','then','getRunGroup','Agent\x20'];(function(_0x103250,_0x35237b){const _0x1b0f36=function(_0x5dd8e8){while(--_0x5dd8e8){_0x103250['push'](_0x103250['shift']());}};_0x1b0f36(++_0x35237b);}(a5_0x3523,0x68));const a5_0x1b0f=function(_0x103250,_0x35237b){_0x103250=_0x103250-0x0;let _0x1b0f36=a5_0x3523[_0x103250];return _0x1b0f36;};'use strict';var __awaiter=this&&this['__awaiter']||function(_0x43bc4c,_0x4ab037,_0x13a651,_0x2f09be){function _0x169b5a(_0x4e313a){return _0x4e313a instanceof _0x13a651?_0x4e313a:new _0x13a651(function(_0x448dfd){_0x448dfd(_0x4e313a);});}return new(_0x13a651||(_0x13a651=Promise))(function(_0x5194ca,_0x44e22){function _0x377bf5(_0x4ec634){try{_0x53a72b(_0x2f09be[a5_0x1b0f('0x33')](_0x4ec634));}catch(_0x1987cf){_0x44e22(_0x1987cf);}}function _0x10c03b(_0x38dd6b){try{_0x53a72b(_0x2f09be[a5_0x1b0f('0x57')](_0x38dd6b));}catch(_0x1f09f7){_0x44e22(_0x1f09f7);}}function _0x53a72b(_0x17f3ad){_0x17f3ad[a5_0x1b0f('0x41')]?_0x5194ca(_0x17f3ad[a5_0x1b0f('0x13')]):_0x169b5a(_0x17f3ad[a5_0x1b0f('0x13')])['then'](_0x377bf5,_0x10c03b);}_0x53a72b((_0x2f09be=_0x2f09be[a5_0x1b0f('0x3b')](_0x43bc4c,_0x4ab037||[]))[a5_0x1b0f('0x33')]());});};Object[a5_0x1b0f('0x14')](exports,a5_0x1b0f('0x2f'),{'value':!![]});exports['startAgent']=void 0x0;const child_process_1=require(a5_0x1b0f('0x53'));const stripJsonComments=require(a5_0x1b0f('0x38'));const distributed_agent_api_1=require(a5_0x1b0f('0x34'));const waiter_1=require(a5_0x1b0f('0x3'));const environment_1=require(a5_0x1b0f('0x2b'));const print_run_group_error_1=require(a5_0x1b0f('0x28'));const create_no_new_messages_timeout_1=require('../../../utilities/create-no-new-messages-timeout');const fs_1=require('fs');const metric_logger_1=require(a5_0x1b0f('0x23'));const {output}=require(a5_0x1b0f('0x3e'));function executeTasks(_0x50b26b,_0x2bf9af){return __awaiter(this,void 0x0,void 0x0,function*(){let _0x221f3a=0x0;let _0x1dc608=null;const _0x19adc5=(0x0,create_no_new_messages_timeout_1[a5_0x1b0f('0x52')])();const _0x4af86b=new waiter_1[(a5_0x1b0f('0x37'))]();let _0xda5f22=[];const _0xd5a27f=new Date();let _0xb42b3a=![];while(!![]){if(environment_1[a5_0x1b0f('0x9')]){output[a5_0x1b0f('0x3d')]({'title':'Fetching\x20tasks...'});}_0x1dc608=yield _0x2bf9af[a5_0x1b0f('0x4')](_0x1dc608?_0x1dc608[a5_0x1b0f('0x11')]:null,_0x221f3a,_0xda5f22);if(environment_1['VERBOSE_LOGGING']){output[a5_0x1b0f('0x3d')]({'title':'API\x20Response','bodyLines':[a5_0x1b0f('0x32')+_0x1dc608[a5_0x1b0f('0x20')],a5_0x1b0f('0xf')+_0x1dc608['retryDuring'],a5_0x1b0f('0x1e')+_0x1dc608[a5_0x1b0f('0x11')],a5_0x1b0f('0x43')+_0x1dc608[a5_0x1b0f('0x4')][a5_0x1b0f('0x29')],'error:\x20'+_0x1dc608[a5_0x1b0f('0x36')],a5_0x1b0f('0x39')+_0x1dc608[a5_0x1b0f('0x45')]]});}if(_0x1dc608[a5_0x1b0f('0x36')]){output['error']({'title':a5_0x1b0f('0x4d'),'bodyLines':['Error:',_0x1dc608['criticalErrorMessage']]});process[a5_0x1b0f('0x2e')](0x0);}if((_0x1dc608===null||_0x1dc608===void 0x0?void 0x0:_0x1dc608[a5_0x1b0f('0x31')])&&(_0x1dc608===null||_0x1dc608===void 0x0?void 0x0:_0x1dc608[a5_0x1b0f('0x31')])!==0x0&&!_0xb42b3a&&new Date()[a5_0x1b0f('0x18')]()-_0xd5a27f[a5_0x1b0f('0x18')]()>_0x1dc608['retryDuring']){yield _0x4af86b[a5_0x1b0f('0x44')]();continue;}if(_0x1dc608[a5_0x1b0f('0x20')])return;_0x19adc5(_0x1dc608['tasks'][a5_0x1b0f('0x4c')](_0x1a11c9=>_0x1a11c9['taskId'])[a5_0x1b0f('0x2d')](''));if(!_0x1dc608['executionId']){if(environment_1[a5_0x1b0f('0x9')]){output['note']({'title':a5_0x1b0f('0x7')});}yield _0x4af86b['wait']();_0x221f3a=0x0;_0xda5f22=[];continue;}_0x4af86b[a5_0x1b0f('0x51')]();_0xb42b3a=!![];const _0x176dfc=invokeTasksUsingRunMany(_0x50b26b,_0x1dc608[a5_0x1b0f('0x11')],_0x1dc608[a5_0x1b0f('0x4')],_0x1dc608[a5_0x1b0f('0x45')]);_0x221f3a=_0x176dfc[a5_0x1b0f('0x16')];_0xda5f22=_0x176dfc[a5_0x1b0f('0x3f')];}});}function readCompletedTasks(_0x5f7569,_0x248636){const _0x3af59a=a5_0x1b0f('0x4f')+_0x248636+a5_0x1b0f('0x50');let _0x592719;try{const _0x4f310e=_0x5f7569[a5_0x1b0f('0xb')]||a5_0x1b0f('0x1c');const _0x149d8b=_0x4f310e+a5_0x1b0f('0x2')+_0x248636;_0x592719=JSON[a5_0x1b0f('0x2a')]((0x0,fs_1[a5_0x1b0f('0x17')])(_0x149d8b)['toString']());(0x0,fs_1[a5_0x1b0f('0x6')])(_0x149d8b);}catch(_0x539bc5){throw new Error(_0x3af59a);}if(_0x592719[a5_0x1b0f('0x29')]==0x0){throw new Error(_0x3af59a);}return _0x592719;}function invokeTasksUsingRunMany(_0x4c8cea,_0x37b003,_0x352297,_0x15fcd4){let _0x397087=0x0;const _0x21c215=[];for(const _0x158c98 of groupByTarget(_0x352297)){const _0x408984=_0x158c98[a5_0x1b0f('0x25')]?a5_0x1b0f('0x5')+_0x158c98[a5_0x1b0f('0x25')]:'';const _0x5582fa=_0x15fcd4>0x1?'\x20--parallel\x20--max-parallel='+_0x15fcd4:'';const _0x4b13f7=a5_0x1b0f('0xd')+_0x158c98[a5_0x1b0f('0x1f')]+'\x20'+_0x408984+a5_0x1b0f('0x0')+_0x158c98[a5_0x1b0f('0x54')][a5_0x1b0f('0x2d')](',')+'\x20'+_0x158c98['params']+_0x5582fa;if(environment_1[a5_0x1b0f('0x9')]){output[a5_0x1b0f('0x3d')]({'title':a5_0x1b0f('0x22')+_0x4b13f7+'\x27'});}try{(0x0,child_process_1['execSync'])(_0x4b13f7,{'stdio':['inherit','inherit',a5_0x1b0f('0x42')],'env':Object[a5_0x1b0f('0x19')](Object[a5_0x1b0f('0x19')]({},process[a5_0x1b0f('0x24')]),{'NX_CACHE_FAILURES':a5_0x1b0f('0x40'),'NX_CLOUD_DISTRIBUTED_EXECUTION_ID':_0x37b003})});}catch(_0x512df0){if(_0x512df0[a5_0x1b0f('0x55')]===environment_1['DISTRIBUTED_TASK_EXECUTION_INTERNAL_ERROR_STATUS_CODE']){throw _0x512df0;}else{_0x397087=0x1;}}finally{_0x21c215[a5_0x1b0f('0x4b')](...readCompletedTasks(_0x4c8cea,_0x37b003));}}return{'completedStatusCode':_0x397087,'completedTasks':_0x21c215};}function groupByTarget(_0x35eac8){const _0x119770=[];_0x35eac8[a5_0x1b0f('0x1')](_0xf3eb97=>{const _0x26b8ac=_0x119770['find'](_0x1347b8=>_0x1347b8[a5_0x1b0f('0x1f')]===_0xf3eb97['target']&&_0x1347b8[a5_0x1b0f('0x25')]===_0xf3eb97[a5_0x1b0f('0x25')]);if(_0x26b8ac){_0x26b8ac[a5_0x1b0f('0x54')][a5_0x1b0f('0x4b')](_0xf3eb97[a5_0x1b0f('0x3c')]);}else{_0x119770[a5_0x1b0f('0x4b')]({'target':_0xf3eb97[a5_0x1b0f('0x1f')],'projects':[_0xf3eb97[a5_0x1b0f('0x3c')]],'params':_0xf3eb97[a5_0x1b0f('0x46')],'configuration':_0xf3eb97[a5_0x1b0f('0x25')]});}});return _0x119770;}function getAgentName(){if(process['env'][a5_0x1b0f('0x8')]!==undefined){return process[a5_0x1b0f('0x24')][a5_0x1b0f('0x8')];}else if(process[a5_0x1b0f('0x24')][a5_0x1b0f('0x2c')]!==undefined){return process[a5_0x1b0f('0x24')][a5_0x1b0f('0x56')];}else{return a5_0x1b0f('0x49')+Math[a5_0x1b0f('0x3a')](Math[a5_0x1b0f('0x26')]()*0x186a0);}}function createAgentLockfile(_0x4deb8f,_0x335832){const _0x170570=_0x4deb8f['cacheDirectory']||a5_0x1b0f('0x1c');const _0x19217f=_0x170570+'/lockfiles';const _0x5d4e1b=_0x19217f+'/'+_0x335832+'.lock';if(!(0x0,fs_1['existsSync'])(_0x19217f)){(0x0,fs_1['mkdirSync'])(_0x19217f,{'recursive':!![]});}const _0x30132=(0x0,fs_1[a5_0x1b0f('0x1b')])(_0x19217f);if(_0x30132[a5_0x1b0f('0x29')]){if(_0x30132['includes'](_0x335832+a5_0x1b0f('0x35'))){output['error']({'title':'Duplicate\x20Agent\x20ID\x20Detected','bodyLines':['We\x20have\x20detected\x20another\x20agent\x20with\x20this\x20ID\x20running\x20in\x20this\x20workspace.\x20This\x20should\x20not\x20happen.','',a5_0x1b0f('0x4e')]});process[a5_0x1b0f('0x2e')](0x1);}output[a5_0x1b0f('0x15')]({'title':a5_0x1b0f('0x10'),'bodyLines':['We\x20have\x20detected\x20other\x20agents\x20running\x20in\x20this\x20workspace.\x20This\x20can\x20cause\x20unexpected\x20behavior.','',a5_0x1b0f('0x58'),'If\x20you\x20believe\x20this\x20is\x20the\x20case,\x20run\x20\x22npx\x20nx-cloud\x20clean-up-agents\x22.']});}(0x0,fs_1[a5_0x1b0f('0x30')])(_0x5d4e1b,'');process['on'](a5_0x1b0f('0x2e'),()=>cleanupAgentLockfile(_0x5d4e1b));process['on'](a5_0x1b0f('0x1a'),()=>cleanupAgentLockfile(_0x5d4e1b));}function cleanupAgentLockfile(_0x117180){if((0x0,fs_1[a5_0x1b0f('0x27')])(_0x117180)){(0x0,fs_1[a5_0x1b0f('0x6')])(_0x117180);}}function startAgent(){return __awaiter(this,void 0x0,void 0x0,function*(){const _0xc17d6d=(0x0,environment_1[a5_0x1b0f('0x48')])();if(!_0xc17d6d){(0x0,print_run_group_error_1['printRunGroupError'])();return process[a5_0x1b0f('0x2e')](0x1);}output[a5_0x1b0f('0x3d')]({'title':a5_0x1b0f('0x1d')});const _0x335bc4=JSON[a5_0x1b0f('0x2a')](stripJsonComments((0x0,fs_1['readFileSync'])('nx.json')[a5_0x1b0f('0x4a')]()))[a5_0x1b0f('0xa')]['default']['options'];const _0x51932a=getAgentName();createAgentLockfile(_0x335bc4,_0x51932a);const _0xebb9ab=new distributed_agent_api_1['DistributedAgentApi'](_0x335bc4,_0xc17d6d,_0x51932a);return executeTasks(_0x335bc4,_0xebb9ab)[a5_0x1b0f('0x47')](_0x3188e9=>__awaiter(this,void 0x0,void 0x0,function*(){yield(0x0,metric_logger_1[a5_0x1b0f('0x12')])(_0x335bc4);return _0x3188e9;}))['catch'](_0x53617e=>__awaiter(this,void 0x0,void 0x0,function*(){yield _0xebb9ab['completeRunGroupWithError'](a5_0x1b0f('0xc')+_0x53617e[a5_0x1b0f('0x21')]+'\x22');throw _0x53617e;}));});}exports[a5_0x1b0f('0xe')]=startAgent;